
@TSC_10
#DIM CONST 참여인원 = 6
#DIM DYNAMIC 참가자, 6
#DIM DYNAMIC 강함
#DIM DYNAMIC 플레이어강함
PRINTFORML 탄막놀이 축제에 참가할까?
CALL ASK_YN
IF RESULT
	RETURN -1
ELSE
	LOCAL = MASTER
	LOCAL:1 = 0
	;1차 매칭
	플레이어강함 = (ABL:LOCAL:전투능력 * 15) + (ABL:LOCAL:레벨 * 2) + (CFLAG:LOCAL:힘 + CFLAG:LOCAL:지성 + CFLAG:LOCAL:속도 + CFLAG:LOCAL:인내+ CFLAG:LOCAL:운)
	FOR LOCAL, 1, CHARANUM
		강함 = 0
		IF CFLAG:LOCAL:현재위치 == CFLAG:MASTER:현재위치
			강함 = (ABL:LOCAL:전투능력 * 15) + (ABL:LOCAL:레벨 * 2) + (CFLAG:LOCAL:힘 + CFLAG:LOCAL:지성 + CFLAG:LOCAL:속도 + CFLAG:LOCAL:인내+ CFLAG:LOCAL:운)
			IF 강함 + 30 <= 플레이어강함 && 강함 - 40 >= 플레이어강함
				참가자:(LOCAL:1) = LOCAL
				LOCAL:1 ++
			ENDIF
		ENDIF
		IF LOCAL:1 >= 참여인원
			GOTO 탄막축제시작
		ENDIF
	NEXT
	;2차 매칭
	IF LOCAL:1 < 참여인원
		FOR LOCAL, 1, CHARANUM
			FOR LOCAL:2 , 0 , 참여인원
				IF 참가자:(LOCAL:2) == LOCAL
					CONTINUE
				ENDIF
			NEXT
			강함 = 0
			IF CFLAG:LOCAL:현재위치 == CFLAG:MASTER:현재위치
				강함 = (ABL:LOCAL:전투능력 * 15) + (ABL:LOCAL:레벨 * 2) + (CFLAG:LOCAL:힘 + CFLAG:LOCAL:지성 + CFLAG:LOCAL:속도 + CFLAG:LOCAL:인내+ CFLAG:LOCAL:운)
				IF 강함 + 90 <= 플레이어강함 && 강함 - 120 >= 플레이어강함
					참가자:(LOCAL:1) = LOCAL
					LOCAL:1 ++
				ENDIF
			ENDIF
			IF LOCAL:1 >= 참여인원
				GOTO 탄막축제시작
			ENDIF
		NEXT
	ENDIF
	;3차 매칭
	IF LOCAL:1 < 참여인원
		FOR LOCAL, 1, CHARANUM
			FOR LOCAL:2 , 0 , 참여인원
				IF 참가자:(LOCAL:2) == LOCAL
					CONTINUE
				ENDIF
			NEXT
			강함 = 0
			IF CFLAG:LOCAL:현재위치 == CFLAG:MASTER:현재위치
				강함 = (ABL:LOCAL:전투능력 * 15) + (ABL:LOCAL:레벨 * 2) + (CFLAG:LOCAL:힘 + CFLAG:LOCAL:지성 + CFLAG:LOCAL:속도 + CFLAG:LOCAL:인내+ CFLAG:LOCAL:운)
				IF 강함 + 150 <= 플레이어강함 && 강함 - 150 >= 플레이어강함
					참가자:(LOCAL:1) = LOCAL
					LOCAL:1 ++
				ENDIF
			ENDIF
			IF LOCAL:1 >= 참여인원
				GOTO 탄막축제시작
			ENDIF
		NEXT
	ENDIF
	;4차 매칭
	IF LOCAL:1 < 참여인원
		FOR LOCAL, 1, CHARANUM
			FOR LOCAL:2 , 0 , 참여인원
				IF 참가자:(LOCAL:2) == LOCAL
					CONTINUE
				ENDIF
			NEXT
			강함 = 0
			IF CFLAG:LOCAL:현재위치 == CFLAG:MASTER:현재위치
				강함 = (ABL:LOCAL:전투능력 * 15) + (ABL:LOCAL:레벨 * 2) + (CFLAG:LOCAL:힘 + CFLAG:LOCAL:지성 + CFLAG:LOCAL:속도 + CFLAG:LOCAL:인내+ CFLAG:LOCAL:운)
				IF 강함 + 350 <= 플레이어강함 && 강함 - 350 >= 플레이어강함
					참가자:(LOCAL:1) = LOCAL
					LOCAL:1 ++
				ENDIF
			ENDIF
			IF LOCAL:1 >= 참여인원
				GOTO 탄막축제시작
			ENDIF
		NEXT
	ENDIF
	;5차 매칭
	IF LOCAL:1 < 참여인원
		FOR LOCAL, 1, CHARANUM
			FOR LOCAL:2 , 0 , 참여인원
				IF 참가자:(LOCAL:2) == LOCAL
					CONTINUE
				ENDIF
			NEXT
			IF CFLAG:LOCAL:현재위치 == CFLAG:MASTER:현재위치
				참가자:(LOCAL:1) = LOCAL
				LOCAL:1 ++
			ENDIF
			IF LOCAL:1 >= 참여인원
				GOTO 탄막축제시작
			ENDIF
		NEXT
	ENDIF
	IF LOCAL:1 < 참여인원 / 2
		PRINTFORML ...그러나 축제를 벌이기엔 참여자가 너무 적었다
	ENDIF
ENDIF

$탄막축제시작
PRINTFORML
탄막놀이축제진행중 = 1
FOR LOCAL,0,LOCAL:1
	TARGET = (참가자:LOCAL)
	PRINTFORML 제 {LOCAL + 1}번째 참가자는 %CALLNAME:TARGET%!!!
	PRINTFORML
	CALL 뉴탄막전투(MASTER,TARGET,0)
	TIME += 20
	DOWNBASE:기력 += 50
	DOWNBASE:MASTER:기력 += 100
	DOWNBASE:체력 += 50
	DOWNBASE:MASTER:체력 += 100
	IF RESULT == 2
		PRINTFORML 
		PRINTFORMW %마스터는% 결국 쓰러지고 말았다...
		BREAK
	ENDIF
	PRINTL
NEXT
탄막놀이축제참가완료 = 1
탄막놀이축제진행중 = 0

@TSC_NAME10
#DIMS DYNAMIC 커맨드이름
커맨드이름 = 탄막놀이 축제 참가
RESULTS = %커맨드이름%

@TSC_ABLE10

IF FLAG:연회개최플래그 != 99 || FLAG:개시일 - DAY != 0 || EnkaiTitle != "탄막놀이 축제"
    RETURN 0
ENDIF
SIF 탄막놀이축제참가완료
	RETURN 0
IF TIME < 720 ;|| TIME > 930
	RETURN 0
ENDIF
IF CFLAG:현재위치 != 202 && CFLAG:현재위치 != 210
	RETURN 0
ENDIF
;기력 0
SIF BASE:MASTER:기력 <= 0
	RETURN 0
SIF CFLAG:우후후 == 2
	RETURN 0
;정지 중에는 불가
SIF FLAG:70
	RETURN 0
RETURN 2


